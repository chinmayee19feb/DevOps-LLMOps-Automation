version: '3.8'

services:
  # MongoDB Database
  mongodb:
    image: mongo:latest
    container_name: restauranty-mongo
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=flor
    networks:
      - restauranty-network

  # Auth Microservice
  auth:
    build:
      context: ./backend/auth
      dockerfile: Dockerfile
    container_name: restauranty-auth
    environment:
      - SECRET=MySecret1!
      - MONGODB_URI=mongodb://mongodb:27017/flor
      - CLOUD_NAME=development
      - CLOUD_API_KEY=123456789
      - CLOUD_API_SECRET=placeholder_secret
      - PORT=3001
    depends_on:
      - mongodb
    networks:
      - restauranty-network
    restart: unless-stopped

  # Discounts Microservice
  discounts:
    build:
      context: ./backend/discounts
      dockerfile: Dockerfile
    container_name: restauranty-discounts
    environment:
      - SECRET=MySecret1!
      - MONGODB_URI=mongodb://mongodb:27017/flor
      - CLOUD_NAME=development
      - CLOUD_API_KEY=123456789
      - CLOUD_API_SECRET=placeholder_secret
      - PORT=3002
    depends_on:
      - mongodb
    networks:
      - restauranty-network
    restart: unless-stopped

  # Items Microservice
  items:
    build:
      context: ./backend/items
      dockerfile: Dockerfile
    container_name: restauranty-items
    environment:
      - SECRET=MySecret1!
      - MONGODB_URI=mongodb://mongodb:27017/flor
      - CLOUD_NAME=development
      - CLOUD_API_KEY=123456789
      - CLOUD_API_SECRET=placeholder_secret
      - PORT=3003
    depends_on:
      - mongodb
    networks:
      - restauranty-network
    restart: unless-stopped

  # React Frontend
  frontend:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: restauranty-frontend
    environment:
      - REACT_APP_API_URL=http://localhost:80
    depends_on:
      - auth
      - discounts
      - items
    networks:
      - restauranty-network
    restart: unless-stopped

  # HAProxy Load Balancer
  haproxy:
    image: haproxy:alpine
    container_name: restauranty-haproxy
    ports:
      - "80:80"
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg
    depends_on:
      - auth
      - discounts
      - items
      - frontend
    networks:
      - restauranty-network
    restart: unless-stopped

volumes:
  mongo_data:

networks:
  restauranty-network:
    driver: bridge